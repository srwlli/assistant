<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeRef Explorer - Project Manager</title>
    <link rel="stylesheet" href="../css/main.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: 60px 1fr;
            min-height: 100vh;
        }

        header {
            grid-column: 1 / -1;
            grid-row: 1;
            border-bottom: 1px solid var(--color-ind-border);
            padding: 0 var(--spacing-lg);
        }

        aside {
            grid-column: 1;
            grid-row: 2;
            border-right: 1px solid var(--color-ind-border);
            overflow-y: auto;
        }

        main {
            grid-column: 2;
            grid-row: 2;
            overflow-y: auto;
            padding: var(--spacing-xl);
        }

        /* Custom styles for CodeRef Explorer */
        .project-selector {
            padding: var(--spacing-md) var(--spacing-lg);
            border-bottom: 1px solid var(--color-ind-border);
        }

        select {
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--color-ind-panel);
            border: 2px solid var(--color-ind-border);
            border-radius: var(--radius-md);
            color: var(--color-ind-text);
            font-family: var(--font-display);
            font-size: 13px;
            cursor: pointer;
        }

        select:focus {
            outline: none;
            border-color: var(--color-ind-accent);
        }

        .project-selector-inline {
            display: flex;
            gap: var(--spacing-sm);
            align-items: center;
            margin-bottom: var(--spacing-md);
            border-bottom: 1px solid var(--color-ind-border);
            padding-bottom: var(--spacing-md);
            width: 100%;
            min-width: 0;
        }

        .project-selector-inline select {
            flex: 1;
            min-width: 0;
            max-width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--color-ind-panel);
            border: 2px solid var(--color-ind-border);
            border-radius: var(--radius-md);
            color: var(--color-ind-text);
            font-family: var(--font-display);
            font-size: 13px;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .project-selector-inline button {
            flex-shrink: 0;
            min-width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .tree-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            user-select: none;
        }

        .tree-item:hover {
            background: rgba(255, 107, 0, 0.1);
        }

        .tree-item.active {
            background: rgba(255, 107, 0, 0.2);
            border-left: 3px solid var(--color-ind-accent);
        }

        .tree-item.coderef-folder {
            background: rgba(255, 107, 0, 0.08);
        }

        .chevron {
            transition: transform 0.2s;
            font-size: 16px;
        }

        .chevron.expanded {
            transform: rotate(90deg);
        }

        .tree-children {
            display: none;
            padding-left: 0;
        }

        .tree-children.show {
            display: block;
        }

        .badge {
            font-size: 9px;
            padding: 2px 4px;
            background: rgba(255, 107, 0, 0.2);
            color: var(--color-ind-accent);
            border-radius: 2px;
            font-weight: 600;
        }

        .file-info {
            display: flex;
            gap: var(--spacing-lg);
            font-size: 12px;
            color: var(--color-ind-text-muted);
            margin-top: var(--spacing-sm);
        }

        .markdown-content {
            line-height: 1.8;
        }

        .markdown-content h1 {
            font-size: 28px;
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
            border-bottom: 2px solid var(--color-ind-border);
            padding-bottom: var(--spacing-md);
        }

        .markdown-content h2 {
            font-size: 22px;
            margin-top: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
        }

        .markdown-content h3 {
            font-size: 18px;
            margin-top: var(--spacing-lg);
            margin-bottom: var(--spacing-sm);
        }

        .markdown-content p {
            margin-bottom: var(--spacing-md);
        }

        .markdown-content code {
            background: var(--color-ind-panel);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: var(--font-mono);
            font-size: 12px;
        }

        .markdown-content pre {
            background: var(--color-ind-panel);
            border: 1px solid var(--color-ind-border);
            border-radius: var(--radius-md);
            padding: var(--spacing-lg);
            overflow-x: auto;
            margin: var(--spacing-md) 0;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
        }

        .markdown-content ul, .markdown-content ol {
            margin-left: var(--spacing-xl);
            margin-bottom: var(--spacing-md);
        }

        .markdown-content li {
            margin-bottom: var(--spacing-sm);
        }

        .markdown-content blockquote {
            border-left: 4px solid var(--color-ind-accent);
            padding-left: var(--spacing-lg);
            margin: var(--spacing-md) 0;
            color: var(--color-ind-text-muted);
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
                grid-template-rows: 60px 50px 1fr;
            }

            aside {
                grid-column: 1 / -1;
                grid-row: 2;
                border-right: none;
                border-bottom: 1px solid var(--color-ind-border);
                display: flex;
                overflow-x: auto;
                overflow-y: hidden;
            }

            main {
                grid-column: 1;
                grid-row: 3;
            }
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--color-ind-panel);
            border: 1px solid var(--color-ind-border);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--color-ind-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: var(--color-ind-text-muted);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--color-ind-text);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--color-ind-border);
            display: flex;
            gap: var(--spacing-md);
            justify-content: flex-end;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-sm);
            font-weight: 600;
            font-size: 13px;
        }

        .industrial-input {
            width: 100%;
            padding: var(--spacing-sm) var(--spacing-md);
            background-color: var(--color-ind-bg);
            border: 2px solid var(--color-ind-border);
            border-radius: var(--radius-md);
            color: var(--color-ind-text);
            font-family: var(--font-display);
            font-size: 14px;
        }

        .industrial-input:focus {
            outline: none;
            border-color: var(--color-ind-primary);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="flex flex-between items-center">
        <div class="flex items-center gap-lg">
            <h1 style="margin: 0; font-size: 20px;">
                <span class="material-symbols-outlined" style="vertical-align: middle; font-size: 28px;">folder_open</span>
                CodeRef Explorer
            </h1>
        </div>
        <div class="flex gap-lg items-center">
            <button class="industrial-button-secondary industrial-button-small" onclick="toggleTheme()">
                <span class="material-symbols-outlined sm">dark_mode</span>
            </button>
            <button class="industrial-button-secondary industrial-button-small">
                <span class="material-symbols-outlined sm">person</span>
            </button>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="p-lg no-scrollbar">
        <nav class="flex flex-col gap-md">
            <!-- Project Selector - Inline with Add Button -->
            <div class="project-selector-inline">
                <select id="project-select" onchange="changeProject(this.value)">
                    <!-- Projects loaded dynamically -->
                </select>
                <button class="industrial-button-secondary industrial-button-small" onclick="showAddProjectDialog()" title="Add new project">
                    <span class="material-symbols-outlined sm">add</span>
                </button>
                <button class="industrial-button-secondary industrial-button-small" onclick="removeCurrentProject()" title="Remove current project">
                    <span class="material-symbols-outlined sm">delete</span>
                </button>
            </div>

            <!-- CodeRef Folder Tree (Dynamic) -->
            <div style="border-top: 1px solid var(--color-ind-border); padding-top: var(--spacing-md);">
                <p class="text-muted text-sm uppercase font-weight-700 mb-md" style="font-size: 11px; letter-spacing: 1px;">CODEREF</p>
                <div class="tree-container">
                    <!-- Tree populated dynamically by JavaScript -->
                </div>
            </div>
        </nav>
    </aside>

    <!-- Main Content -->
    <main>
        <!-- Body Header -->
        <div class="flex flex-between items-center mb-xl">
            <div>
                <div class="file-breadcrumb" style="display: flex; align-items: center; gap: var(--spacing-sm); font-size: 12px; color: var(--color-ind-text-muted); margin-bottom: var(--spacing-sm);">
                    Select a file to view
                </div>
                <h2 class="file-title">No file selected</h2>
                <div class="file-meta file-info" style="font-size: 12px; color: var(--color-ind-text-muted);">
                    Click a file in the sidebar to view its contents
                </div>
            </div>
            <div style="display: flex; gap: var(--spacing-sm);">
                <button id="copyPathBtn" class="industrial-button-secondary industrial-button-small" onclick="copyPath()" title="Copy file path" disabled>
                    <span class="material-symbols-outlined sm">content_copy</span>
                    Copy Path
                </button>
                <button id="copyCodeBtn" class="industrial-button-secondary industrial-button-small" onclick="copyCode()" title="Copy file content" disabled>
                    <span class="material-symbols-outlined sm">code</span>
                    Copy Code
                </button>
                <button id="shareLinkBtn" class="industrial-button-secondary industrial-button-small" onclick="shareLink()" title="Share link" disabled>
                    <span class="material-symbols-outlined sm">share</span>
                    Share
                </button>
            </div>
        </div>

        <!-- File Contents -->
        <div class="industrial-panel">
            <div class="body-content markdown-content" style="min-height: 400px;">
                <p style="color: var(--color-ind-text-muted); text-align: center; padding: var(--spacing-xl);">
                    Select a file from the sidebar to view its contents
                </p>
            </div>
        </div>
    </main>
    <!-- Add Project Modal -->
    <div id="addProjectModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Project</h3>
                <button class="modal-close" onclick="closeAddProjectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="projectName">Project Name</label>
                    <input type="text" id="projectName" placeholder="Enter project name..." class="industrial-input">
                </div>
                <div class="form-group">
                    <label for="projectPath">Project Folder Path</label>
                    <div style="display: flex; gap: var(--spacing-sm);">
                        <input type="text" id="projectPath" placeholder="e.g., C:\Users\willh\Desktop\assistant\coderef" class="industrial-input" style="flex: 1;">
                        <button class="industrial-button-secondary" onclick="browseFolderForPath()" title="Browse for folder">
                            <span class="material-symbols-outlined sm">folder_open</span>
                            Browse
                        </button>
                    </div>
                    <p class="text-muted text-sm" style="margin-top: var(--spacing-sm);">
                        Type the path or click Browse to select a folder
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="industrial-button-secondary" onclick="closeAddProjectModal()">Cancel</button>
                <button id="addProjectBtn" class="industrial-button-primary" onclick="confirmAddProject()" disabled>Add Project</button>
            </div>
        </div>
    </div>

    <script>
        // Project management
        let projects = [];
        let currentProject = null;

        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                projects = await response.json();

                renderProjectSelector();

                if (projects.length > 0) {
                    changeProject(projects[0].id);
                } else {
                    // Show empty state
                    document.querySelector('.tree-container').innerHTML = `
                        <div style="padding: var(--spacing-lg); color: var(--color-ind-text-muted); text-align: center;">
                            No projects. Click + to add one.
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading projects:', error);
                showToast('Error loading projects');
            }
        }

        async function saveProject(project) {
            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(project)
                });
                const result = await response.json();
                return result.success;
            } catch (error) {
                console.error('Error saving project:', error);
                return false;
            }
        }

        function renderProjectSelector() {
            const select = document.getElementById('project-select');
            select.innerHTML = '';

            if (projects.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No projects';
                option.disabled = true;
                select.appendChild(option);
                return;
            }

            projects.forEach(project => {
                const option = document.createElement('option');
                option.value = project.id;
                option.textContent = project.name;
                select.appendChild(option);
            });

            if (currentProject) {
                select.value = currentProject.id;
            }
        }

        async function changeProject(projectId) {
            currentProject = projects.find(p => p.id === projectId);
            if (!currentProject) return;

            // Check if this project has browsed files cached
            if (projectBrowsedFilesCache[projectId]) {
                buildTreeFromBrowsedFiles(projectBrowsedFilesCache[projectId]);
            } else {
                // Load from server
                try {
                    const response = await fetch(`/api/tree?path=${encodeURIComponent(currentProject.path)}`);
                    const tree = await response.json();
                    renderServerTree(tree);
                } catch (error) {
                    console.error('Error loading project tree:', error);
                    showToast('Error loading project folder');
                }
            }
        }

        function buildTreeFromBrowsedFiles(files) {
            const tree = {};

            files.forEach(file => {
                const parts = file.webkitRelativePath.split('/');
                let current = tree;

                parts.forEach((part, index) => {
                    if (index === parts.length - 1) {
                        // It's a file
                        if (!current._files) current._files = [];
                        current._files.push({ name: part, file: file });
                    } else {
                        // It's a folder
                        if (!current[part]) current[part] = {};
                        current = current[part];
                    }
                });
            });

            // Render the tree
            const treeContainer = document.querySelector('.tree-container');
            treeContainer.innerHTML = '';

            const rootName = Object.keys(tree)[0] || 'coderef';
            renderBrowsedTreeNode(rootName, tree[rootName], treeContainer, true);
        }

        function renderBrowsedTreeNode(name, node, parentElement, isRoot = false) {
            const hasChildren = Object.keys(node).some(key => key !== '_files');
            const hasFiles = node._files && node._files.length > 0;

            if (hasChildren || hasFiles) {
                // Folder
                const folderDiv = document.createElement('div');
                folderDiv.className = `tree-item folder ${isRoot ? 'active' : ''}`;
                folderDiv.onclick = () => toggleFolder(folderDiv);

                folderDiv.innerHTML = `
                    <span class="material-symbols-outlined chevron ${isRoot ? 'expanded' : ''}">chevron_right</span>
                    <span class="material-symbols-outlined icon">folder</span>
                    <span>${name}</span>
                `;

                parentElement.appendChild(folderDiv);

                const childrenDiv = document.createElement('div');
                childrenDiv.className = `tree-children ${isRoot ? 'show' : ''}`;

                // Render subfolders
                Object.keys(node).forEach(key => {
                    if (key !== '_files') {
                        renderBrowsedTreeNode(key, node[key], childrenDiv);
                    }
                });

                // Render files
                if (hasFiles) {
                    node._files.forEach(fileObj => {
                        const fileDiv = document.createElement('div');
                        fileDiv.className = 'tree-item file';
                        fileDiv.onclick = (e) => {
                            e.stopPropagation();
                            loadBrowsedFile(fileObj.file, fileDiv);
                        };

                        fileDiv.innerHTML = `
                            <span class="material-symbols-outlined icon">description</span>
                            <span>${fileObj.name}</span>
                        `;

                        childrenDiv.appendChild(fileDiv);
                    });
                }

                parentElement.appendChild(childrenDiv);
            }
        }

        function loadBrowsedFile(file, element) {
            // Remove active class from all tree items
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('active');
            });
            // Add active to clicked item
            element.classList.add('active');

            const reader = new FileReader();

            reader.onload = (e) => {
                const content = e.target.result;
                currentFileContent = content;
                currentFilePath = file.webkitRelativePath;

                displayFileContent(file.name, content, file.webkitRelativePath, file.size, file.lastModified);
            };

            reader.readAsText(file);
        }

        function showAddProjectDialog() {
            document.getElementById('addProjectModal').style.display = 'flex';
            document.getElementById('projectName').value = '';
            document.getElementById('projectPath').value = '';
            document.getElementById('addProjectBtn').disabled = true;
        }

        function closeAddProjectModal() {
            document.getElementById('addProjectModal').style.display = 'none';
        }

        let pendingBrowsedFiles = null;

        function browseFolderForPath() {
            const input = document.createElement('input');
            input.type = 'file';
            input.webkitdirectory = true;
            input.multiple = true;

            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    pendingBrowsedFiles = files;
                    const firstFile = files[0];
                    const parts = firstFile.webkitRelativePath.split('/');
                    const folderName = parts[0];

                    // Set a placeholder path
                    document.getElementById('projectPath').value = `[Browsed: ${folderName}]`;

                    // Auto-populate project name if empty
                    const nameInput = document.getElementById('projectName');
                    if (!nameInput.value) {
                        nameInput.value = folderName;
                    }

                    // Manually enable the Add button
                    document.getElementById('addProjectBtn').disabled = false;

                    showToast(`Selected folder: ${folderName} (${files.length} files)`);
                }
            };

            input.click();
        }

        // Store browsed files by project ID (in-memory, not persisted)
        let projectBrowsedFilesCache = {};

        async function confirmAddProject() {
            const name = document.getElementById('projectName').value.trim();
            const path = document.getElementById('projectPath').value.trim();

            if (!name || !path) {
                showToast('Please fill in all fields');
                return;
            }

            const id = name.toLowerCase().replace(/\s+/g, '-');

            // Check if user browsed files (in-memory mode)
            if (pendingBrowsedFiles) {
                // In-memory mode: use File objects directly
                projectBrowsedFilesCache[id] = pendingBrowsedFiles;

                const project = { id, name, path: '[Browsed - Not Persisted]' };
                projects.push(project);

                renderProjectSelector();
                currentProject = project;
                document.getElementById('project-select').value = id;

                // Render tree from browsed files
                buildTreeFromBrowsedFiles(pendingBrowsedFiles);

                closeAddProjectModal();
                pendingBrowsedFiles = null;
                showToast('Project added (files cached in browser)');
            } else {
                // Server mode: save path to server
                const project = { id, name, path };
                const success = await saveProject(project);

                if (success) {
                    await loadProjects();
                    currentProject = projects.find(p => p.id === id);
                    if (currentProject) {
                        document.getElementById('project-select').value = id;
                        changeProject(id);
                    }
                    closeAddProjectModal();
                    showToast('Project added and persisted!');
                } else {
                    showToast('Error: Invalid project path');
                }
            }
        }

        // Enable Add button when both fields are filled
        document.addEventListener('DOMContentLoaded', () => {
            const nameInput = document.getElementById('projectName');
            const pathInput = document.getElementById('projectPath');

            const validateForm = () => {
                const hasName = nameInput.value.trim().length > 0;
                const hasPath = pathInput.value.trim().length > 0;
                document.getElementById('addProjectBtn').disabled = !(hasName && hasPath);
            };

            if (nameInput && pathInput) {
                nameInput.addEventListener('input', validateForm);
                pathInput.addEventListener('input', validateForm);
            }
        });

        async function removeCurrentProject() {
            if (!currentProject) {
                alert('No project selected');
                return;
            }

            if (!confirm(`Remove project "${currentProject.name}"?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/projects/${currentProject.id}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    await loadProjects();
                    showToast('Project removed');
                } else {
                    showToast('Error removing project');
                }
            } catch (error) {
                console.error('Error removing project:', error);
                showToast('Error removing project');
            }
        }

        function renderServerTree(tree) {
            const treeContainer = document.querySelector('.tree-container');
            treeContainer.innerHTML = '';
            renderServerTreeNode(tree, treeContainer, true);
        }

        function renderServerTreeNode(node, parentElement, isRoot = false) {
            if (node.type === 'folder') {
                // Folder
                const folderDiv = document.createElement('div');
                folderDiv.className = `tree-item folder ${isRoot ? 'active' : ''}`;
                folderDiv.onclick = () => toggleFolder(folderDiv);

                folderDiv.innerHTML = `
                    <span class="material-symbols-outlined chevron ${isRoot ? 'expanded' : ''}">chevron_right</span>
                    <span class="material-symbols-outlined icon">folder</span>
                    <span>${node.name}</span>
                `;

                parentElement.appendChild(folderDiv);

                const childrenDiv = document.createElement('div');
                childrenDiv.className = `tree-children ${isRoot ? 'show' : ''}`;

                if (node.children && node.children.length > 0) {
                    node.children.forEach(child => {
                        renderServerTreeNode(child, childrenDiv);
                    });
                }

                parentElement.appendChild(childrenDiv);
            } else {
                // File
                const fileDiv = document.createElement('div');
                fileDiv.className = 'tree-item file';
                fileDiv.onclick = (e) => {
                    e.stopPropagation();
                    loadServerFile(node.path, fileDiv);
                };

                fileDiv.innerHTML = `
                    <span class="material-symbols-outlined icon">description</span>
                    <span>${node.name}</span>
                `;

                parentElement.appendChild(fileDiv);
            }
        }

        let currentFileContent = '';
        let currentFilePath = '';

        async function loadServerFile(filePath, element) {
            // Remove active class from all tree items
            document.querySelectorAll('.tree-item').forEach(item => {
                item.classList.remove('active');
            });
            // Add active to clicked item
            element.classList.add('active');

            try {
                const response = await fetch(`/api/file?path=${encodeURIComponent(filePath)}`);
                const fileInfo = await response.json();

                currentFileContent = fileInfo.content;
                currentFilePath = filePath;

                displayFileContent(fileInfo.name, fileInfo.content, filePath, fileInfo.size, fileInfo.modified);
            } catch (error) {
                console.error('Error loading file:', error);
                showToast('Error loading file');
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.contains('dark');

            if (isDark) {
                html.classList.remove('dark');
                html.classList.add('light');
                localStorage.setItem('theme', 'light');
            } else {
                html.classList.remove('light');
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
            }
        }

        function toggleFolder(element) {
            element.classList.toggle('active');
            const chevron = element.querySelector('.chevron');
            const nextSibling = element.nextElementSibling;

            if (chevron) {
                chevron.classList.toggle('expanded');
            }

            if (nextSibling && nextSibling.classList.contains('tree-children')) {
                nextSibling.classList.toggle('show');
            }
        }

        function displayFileContent(fileName, content, filePath, fileSize, lastModified) {
            const breadcrumb = filePath.split('/').join(' / ');

            // Update breadcrumb
            document.querySelector('.file-breadcrumb').textContent = breadcrumb;

            // Update file title
            document.querySelector('.file-title').textContent = fileName;

            // Enable copy/share buttons
            document.getElementById('copyPathBtn').disabled = false;
            document.getElementById('copyCodeBtn').disabled = false;
            document.getElementById('shareLinkBtn').disabled = false;

            // Update metadata
            const date = new Date(lastModified).toLocaleDateString();
            const size = (fileSize / 1024).toFixed(2);
            document.querySelector('.file-meta').textContent = `${size} KB â€¢ Modified ${date}`;

            // Render content
            const bodyContent = document.querySelector('.body-content');

            if (fileName.endsWith('.json')) {
                // JSON with syntax highlighting
                const highlighted = syntaxHighlightJSON(content);
                bodyContent.innerHTML = `<pre><code>${highlighted}</code></pre>`;
            } else if (fileName.endsWith('.md')) {
                // Markdown rendered as HTML
                bodyContent.innerHTML = marked.parse(content);
            } else {
                // Plain text
                bodyContent.innerHTML = `<pre><code>${escapeHtml(content)}</code></pre>`;
            }
        }

        function syntaxHighlightJSON(json) {
            return json
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                    let cls = 'number';
                    if (/^"/.test(match)) {
                        if (/:$/.test(match)) {
                            cls = 'key';
                            match = match.slice(0, -1); // Remove the colon for coloring, add back later
                            return '<span style="color: orange;">' + match + '</span>:';
                        } else {
                            cls = 'string';
                            return '<span style="color: #90EE90;">' + match + '</span>';
                        }
                    } else if (/true|false/.test(match)) {
                        cls = 'boolean';
                        return '<span style="color: #87CEEB;">' + match + '</span>';
                    } else if (/null/.test(match)) {
                        cls = 'null';
                        return '<span style="color: #DDA0DD;">' + match + '</span>';
                    }
                    return '<span style="color: yellow;">' + match + '</span>';
                });
        }

        function escapeHtml(text) {
            return text
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function copyPath() {
            if (currentFilePath) {
                navigator.clipboard.writeText(currentFilePath).then(() => {
                    showToast('Path copied to clipboard!');
                });
            }
        }

        function copyCode() {
            if (currentFileContent) {
                navigator.clipboard.writeText(currentFileContent).then(() => {
                    showToast('Code copied to clipboard!');
                });
            }
        }

        function shareLink() {
            if (currentFilePath) {
                const url = window.location.href.split('?')[0] + '?file=' + encodeURIComponent(currentFilePath);
                navigator.clipboard.writeText(url).then(() => {
                    showToast('Share link copied to clipboard!');
                });
            }
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                background: var(--color-ind-primary);
                color: white;
                padding: 12px 24px;
                border-radius: 6px;
                font-size: 14px;
                z-index: 10000;
                animation: fadeInOut 2s ease-in-out;
            `;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // Initialize theme from localStorage
        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            const html = document.documentElement;
            html.classList.remove('dark', 'light');
            html.classList.add(savedTheme);
        }

        // Initialize on page load
        initTheme();
        loadProjects();
    </script>
</body>
</html>
